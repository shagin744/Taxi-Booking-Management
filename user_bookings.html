<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Bookings</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: url('my_booking.jpeg') no-repeat center center fixed;
      background-size: cover;
    }
    .container { margin-top: 40px; }
    h2 { margin-bottom: 30px; text-align: center; color: white; }

    .status-badge { padding: 5px 12px; border-radius: 12px; font-size: 0.85rem; }
    .confirmed { background-color: #198754; color: white; }
    .pending { background-color: #ffc107; color: black; }
    .cancelled { background-color: #dc3545; color: white; }

    /* Mobile tweaks */
    @media (max-width: 768px) {
      h2 { font-size: 1.5rem; }
      .table th, .table td { font-size: 0.85rem; padding: 6px; }
      .btn-sm { padding: 4px 8px; font-size: 0.8rem; }
    }
  </style>
</head>
<body>
<div class="container">

  <!-- Back to Home -->
  <div class="mb-3">
    <a href="{{ url_for('index') }}" class="btn btn-secondary btn-sm">← Back to Home</a>
  </div>

  <h2>My Bookings</h2>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if bookings %}
  <!-- Search -->
  <div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Search by Name...">
  </div>

  <!-- Responsive Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle text-center" id="bookingTable">
      <thead class="table-dark">
        <tr>
          <th>Name</th>
          <th class="d-none d-md-table-cell">Email</th>
          <th class="d-none d-md-table-cell">Contact</th>
          <th>Pickup</th>
          <th>Drop</th>
          <th>Fare (₹)</th>
          <th class="d-none d-md-table-cell">Distance</th>
          <th class="d-none d-md-table-cell">Vehicle</th>
          <th>Date</th>
          <th class="d-none d-md-table-cell">Time</th>
          <th>Status</th>
          <th class="d-none d-md-table-cell">Cancel Reason</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for booking in bookings %}
        <tr>
          <td>{{ booking.name }}</td>
          <td class="d-none d-md-table-cell">{{ booking.user }}</td>
          <td class="d-none d-md-table-cell">{{ booking.phone }}</td>
          <td>{{ booking.pickup }}</td>
          <td>{{ booking.drop }}</td>
          <td>₹ {{ "%.2f"|format(booking.final_fare) }}</td>
          <td class="d-none d-md-table-cell">{{ booking.distance }} km</td>
          <td class="d-none d-md-table-cell">{{ booking.vehicle_type }}</td>
          <td>{{ booking.date }}</td>
          <td class="d-none d-md-table-cell">{{ booking.time }}</td>

          <!-- Status -->
          <td>
            {% if booking.status == "Confirmed" %}
              <span class="status-badge confirmed">Confirmed</span>
            {% elif booking.status == "Pending" %}
              <span class="status-badge pending">Pending</span>
            {% elif booking.status == "Cancelled" %}
              <span class="status-badge cancelled">Cancelled</span>
            {% else %}
              <span class="status-badge">{{ booking.status }}</span>
            {% endif %}
          </td>

          <!-- Cancel Reason -->
          <td class="d-none d-md-table-cell">
            {% if booking.status == "Cancelled" %}
              {{ booking.cancel_reason or "No reason provided" }}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>

          <!-- Action -->
          <td>
            {% if booking.status != "Cancelled" %}
              <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#cancelModal{{ booking._id }}">Cancel</button>
            {% else %}
              <a href="{{ url_for('cancelled_invoice', booking_id=booking._id) }}" class="btn btn-primary btn-sm">Invoice</a>
            {% endif %}
          </td>
        </tr>

        <!-- Cancel Modal -->
        <div class="modal fade" id="cancelModal{{ booking._id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <form action="{{ url_for('user_cancel_booking', booking_id=booking._id) }}" method="POST" class="cancel-form">
                <div class="modal-header">
                  <h5 class="modal-title">Cancel Booking</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <p>Select a reason:</p>
                  <div class="form-check">
                    <input class="form-check-input reason-radio" type="radio" name="cancel_reason" value="Change of plans" required>
                    <label class="form-check-label">Change of plans</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input reason-radio" type="radio" name="cancel_reason" value="Booked by mistake">
                    <label class="form-check-label">Booked by mistake</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input reason-radio" type="radio" name="cancel_reason" value="Driver delay">
                    <label class="form-check-label">Driver delay</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input reason-radio" type="radio" name="cancel_reason" value="Other">
                    <label class="form-check-label">Other</label>
                  </div>
                  <textarea class="form-control mt-2 d-none other-textarea" name="other_reason" placeholder="Enter reason..."></textarea>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-danger btn-sm">Confirm Cancel</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}
  <div class="text-center p-5 text-white">
    <h5>No Bookings Found</h5>
    <p>Looks like you haven't booked any rides yet.</p>
    <a href="{{ url_for('index') }}" class="btn btn-primary">Book a Ride</a>
  </div>
  {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Search filter
document.getElementById("searchInput").addEventListener("keyup", function () {
  let filter = this.value.toLowerCase();
  let rows = document.querySelectorAll("#bookingTable tbody tr");
  rows.forEach(row => {
    let nameCell = row.querySelector("td:first-child");
    if (nameCell) {
      let nameText = nameCell.textContent.toLowerCase();
      row.style.display = nameText.includes(filter) ? "" : "none";
    }
  });
});

// Show/hide "Other reason"
document.querySelectorAll('.reason-radio').forEach(radio => {
  radio.addEventListener('change', function() {
    const textarea = this.closest('.modal-body').querySelector('.other-textarea');
    if (this.value === 'Other') {
      textarea.classList.remove('d-none'); textarea.required = true;
    } else {
      textarea.classList.add('d-none'); textarea.required = false;
    }
  });
});
</script>
</body>
</html>

